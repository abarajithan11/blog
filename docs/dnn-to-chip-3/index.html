<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Neural Chip Design [3/4: RTL Design &amp; Verification]</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="preload" href="../assets/css/app.css%3Fv=b8c8d4f5ca.css" as="style" />
    <link rel="preload" href="../assets/js/manifest.js%3Fv=b8c8d4f5ca" as="script" />
    <link rel="preload" href="../assets/js/vendor/content-api.min.js%3Fv=b8c8d4f5ca" as="script" />
    <link rel="preload" href="../assets/js/vendor.js%3Fv=b8c8d4f5ca" as="script" />
    <link rel="preload" href="../assets/js/app.js%3Fv=b8c8d4f5ca" as="script" />
    <link rel="preconnect" href="https://polyfill.io">
    <link rel="dns-prefetch" href="https://polyfill.io">

      <link rel="preload" href="../assets/css/post.css%3Fv=b8c8d4f5ca.css" as="style" />
  <link rel="preload" href="../assets/js/post.js%3Fv=b8c8d4f5ca" as="script" />


    <style>
      /* These font-faces are here to make fonts work if the Ghost instance is installed in a subdirectory */

      /* source-sans-pro-regular */
      @font-face {
        font-family: 'Source Sans Pro';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: local('SourceSansPro-Regular'),
            url("../assets/fonts/source-sans-pro/latin/source-sans-pro-regular.woff2%3Fv=b8c8d4f5ca") format('woff2'),
            url("../assets/fonts/source-sans-pro/latin/source-sans-pro-regular.woff%3Fv=b8c8d4f5ca") format('woff');
      }

      /* source-sans-pro-600 */
      @font-face {
        font-family: 'Source Sans Pro';
        font-style: normal;
        font-weight: 600;
        font-display: swap;
        src: local('SourceSansPro-SemiBold'),
            url("../assets/fonts/source-sans-pro/latin/source-sans-pro-600.woff2%3Fv=b8c8d4f5ca") format('woff2'),
            url("../assets/fonts/source-sans-pro/latin/source-sans-pro-600.woff%3Fv=b8c8d4f5ca") format('woff');
      }

      /* source-sans-pro-700 */
      @font-face {
        font-family: 'Source Sans Pro';
        font-style: normal;
        font-weight: 700;
        font-display: swap;
        src: local('SourceSansPro-Bold'),
            url("../assets/fonts/source-sans-pro/latin/source-sans-pro-700.woff2%3Fv=b8c8d4f5ca") format('woff2'),
            url("../assets/fonts/source-sans-pro/latin/source-sans-pro-700.woff%3Fv=b8c8d4f5ca") format('woff');
      }

      /* iconmoon */
      @font-face {
        font-family: 'icomoon';
        font-weight: normal;
        font-style: normal;
        font-display: swap;
        src: url("../assets/fonts/icomoon/icomoon.eot%3F101fc3%3Fv=b8c8d4f5ca");
        src: url("../assets/fonts/icomoon/icomoon.eot%3F101fc3") format('embedded-opentype'),
        url("../assets/fonts/icomoon/icomoon.ttf%3F101fc3%3Fv=b8c8d4f5ca") format('truetype'),
        url("../assets/fonts/icomoon/icomoon.woff%3F101fc3%3Fv=b8c8d4f5ca") format('woff'),
        url("../assets/fonts/icomoon/icomoon.svg%3F101fc3") format('svg');
      }
    </style>

    <link rel="stylesheet" type="text/css" href="../assets/css/app.css%3Fv=b8c8d4f5ca.css" media="screen" />

      <link rel="stylesheet" type="text/css" href="../assets/css/post.css%3Fv=b8c8d4f5ca.css" media="screen" />


    

    <meta name="description" content="How I designed modules in the whiteboard, then wrote SystemVerilog RTL, built testbenches, prepared test vectors, and debugged them." />
    <link rel="icon" href="../favicon.png" type="image/png" />
    <link rel="canonical" href="index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="amp/index.html" />
    
    <meta property="og:site_name" content="Aba&#x27;s Blog" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Neural Chip Design [3/4: RTL Design &amp; Verification]" />
    <meta property="og:description" content="How I designed modules in the whiteboard, then wrote SystemVerilog RTL, built testbenches, prepared test vectors, and debugged them." />
    <meta property="og:url" content="https://aba-blog.xyz/dnn-to-chip-3/" />
    <meta property="og:image" content="https://aba-blog.xyz/content/images/size/w2000/2022/01/vlcsnap-2022-01-30-00h01m19s402.png" />
    <meta property="article:published_time" content="2022-01-29T10:36:04.000Z" />
    <meta property="article:modified_time" content="2022-01-31T04:17:02.000Z" />
    <meta property="article:tag" content="Technical Projects" />
    
    <meta property="article:publisher" content="https://www.facebook.com/abarajithan11" />
    <meta property="article:author" content="https://www.facebook.com/abarajithan11" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Neural Chip Design [3/4: RTL Design &amp; Verification]" />
    <meta name="twitter:description" content="How I designed modules in the whiteboard, then wrote SystemVerilog RTL, built testbenches, prepared test vectors, and debugged them." />
    <meta name="twitter:url" content="https://aba-blog.xyz/dnn-to-chip-3/" />
    <meta name="twitter:image" content="https://aba-blog.xyz/content/images/size/w2000/2022/01/vlcsnap-2022-01-30-00h01m19s402.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Abarajithan G" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Technical Projects" />
    <meta property="og:image:width" content="1448" />
    <meta property="og:image:height" content="724" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Aba&#x27;s Blog",
        "url": "https://aba-blog.xyz/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://aba-blog.xyz/favicon.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Abarajithan G",
        "image": {
            "@type": "ImageObject",
            "url": "https://aba-blog.xyz/content/images/2021/11/im_large_vignette.jpg",
            "width": 1600,
            "height": 1600
        },
        "url": "https://aba-blog.xyz/author/aba/",
        "sameAs": [
            "https://www.linkedin.com/in/abarajithan11",
            "https://www.facebook.com/abarajithan11"
        ]
    },
    "headline": "Neural Chip Design [3/4: RTL Design &amp; Verification]",
    "url": "https://aba-blog.xyz/dnn-to-chip-3/",
    "datePublished": "2022-01-29T10:36:04.000Z",
    "dateModified": "2022-01-31T04:17:02.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://aba-blog.xyz/content/images/2022/01/vlcsnap-2022-01-30-00h01m19s402.png",
        "width": 1448,
        "height": 724
    },
    "keywords": "Technical Projects",
    "description": "How I designed modules in the whiteboard, then wrote SystemVerilog RTL, built testbenches, prepared test vectors, and debugged them.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://aba-blog.xyz/"
    }
}
    </script>

    <meta name="generator" content="Ghost 4.32" />
    <link rel="alternate" type="application/rss+xml" title="Aba&#x27;s Blog" href="../rss/index.html" />
    <script defer src="https://unpkg.com/@tryghost/portal@~1.13.0/umd/portal.min.js" data-ghost="https://aba-blog.xyz/" crossorigin="anonymous"></script><style id="gh-members-styles">.gh-post-upgrade-cta-content,
.gh-post-upgrade-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    width: 100%;
    color: #ffffff;
    font-size: 16px;
}

.gh-post-upgrade-cta-content {
    border-radius: 8px;
    padding: 40px 4vw;
}

.gh-post-upgrade-cta h2 {
    color: #ffffff;
    font-size: 28px;
    letter-spacing: -0.2px;
    margin: 0;
    padding: 0;
}

.gh-post-upgrade-cta p {
    margin: 20px 0 0;
    padding: 0;
}

.gh-post-upgrade-cta small {
    font-size: 16px;
    letter-spacing: -0.2px;
}

.gh-post-upgrade-cta a {
    color: #ffffff;
    cursor: pointer;
    font-weight: 500;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a:hover {
    color: #ffffff;
    opacity: 0.8;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a.gh-btn {
    display: block;
    background: #ffffff;
    text-decoration: none;
    margin: 28px 0 0;
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.gh-post-upgrade-cta a.gh-btn:hover {
    opacity: 0.92;
}</style>
    <script defer src="../public/cards.min.js%3Fv=b8c8d4f5ca"></script>
    <link rel="stylesheet" type="text/css" href="../public/cards.min.css%3Fv=b8c8d4f5ca.css">
    <meta property="fb:admins" content="abarajithan11"/>
<style>
.post-template {
    text-align: justify;
}
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.css" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/katex.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.1/dist/contrib/auto-render.min.js" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script>
  const ghostSearchApiKey = 'f615b479aa70555d4c87186458'
</script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/plugins/toolbar/prism-toolbar.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism-themes/1.9.0/prism-coldark-dark.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/plugins/line-numbers/prism-line-numbers.min.css" />
<style>
    pre[class*=language-] {
        margin: 0.5em 0;
        font-size: 0.8rem;
        background: #111;
    }
</style><style>:root {--ghost-accent-color: #2861bd;}</style>

    <style>
      :root {
        --primary-subtle-color: var(--ghost-accent-color) !important;
      }
    </style>

    <script>
      // @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&dn=expat.txt Expat
      const ghostHost = "https://aba-blog.xyz"
      // @license-end
    </script>

  </head>
  <body class="post-template tag-tech-projects">
    



  
<header class="m-header with-picture js-header">
  <div class="m-mobile-topbar" data-aos="fade-down">
    <button class="m-icon-button in-mobile-topbar js-open-menu" aria-label="Open menu">
      <span class="icon-menu" aria-hidden="true"></span>
    </button>
      <a href="../index.html" class="m-site-name in-mobile-topbar">
        Aba&#x27;s Blog
      </a>
    <button class="m-icon-button in-mobile-topbar js-open-search" aria-label="Open search">
      <span class="icon-search" aria-hidden="true"></span>
    </button>
  </div>

  <div class="m-menu js-menu">
    <button class="m-icon-button outlined as-close-menu js-close-menu" aria-label="Close menu">
      <span class="icon-close"></span>
    </button>
    <div class="m-menu__main" data-aos="fade-down">
      <div class="l-wrapper">
        <div class="m-nav js-main-nav">
          <nav class="m-nav__left js-main-nav-left" role="navigation" aria-label="Main menu">
            <ul>
                <li class="only-desktop">
                  <a href="../index.html" class="m-site-name in-desktop-menu">
                    Aba&#x27;s Blog
                  </a>
                </li>
                
    <li class="nav-cv">
      <a href="https://aba-blog.xyz/cv.pdf">CV</a>
    </li>
    <li class="nav-tech-projects">
      <a href="../tag/tech-projects/index.html">Tech Projects</a>
    </li>
    <li class="nav-travels">
      <a href="../tag/travels/index.html">Travels</a>
    </li>
    <li class="nav-thoughts">
      <a href="../tag/thoughts/index.html">Thoughts</a>
    </li>
    <li class="nav-stories">
      <a href="../tag/stories/index.html">Stories</a>
    </li>
    <li class="nav-reviews">
      <a href="../tag/reviews/index.html">Reviews</a>
    </li>
    <li class="nav-teaching">
      <a href="../tag/teaching/index.html">Teaching</a>
    </li>
    <li class="nav-community-work">
      <a href="../tag/community-work/index.html">Community Work</a>
    </li>

              <li class="submenu-option js-submenu-option">
                <button class="m-icon-button in-menu-main more js-toggle-submenu" aria-label="Open submenu">
                  <span class="icon-more" aria-hidden="true"></span>
                </button>
                <div class="m-submenu js-submenu">
                  <div class="l-wrapper in-submenu">
                    <section class="m-recent-articles">
                      <h3 class="m-submenu-title in-recent-articles">Recent articles</h3>
                          <div class="glide js-recent-slider">
                            <div class="glide__track" data-glide-el="track">
                              <div class="glide__slides">
                                <div class="glide__slide">
                                  <a href="../dnn-to-chip-4/index.html" class="m-recent-article">
                                    <div class="m-recent-article__picture ">
                                        <img src="../content/images/size/w300/2022/01/sys-4.jpg" loading="lazy" alt="">
                                    </div>
                                    <h3 class="m-recent-article__title js-recent-article-title" title="Neural Chip Design [4/4: SoC Integration &amp; Firmware]">
                                      Neural Chip Design [4/4: SoC Integration &amp; Firmware]
                                    </h3>
                                    <span class="m-recent-article__date">a month ago</span>
                                  </a>
                                </div>
                                <div class="glide__slide">
                                  <a href="index.html" class="m-recent-article">
                                    <div class="m-recent-article__picture ">
                                        <img src="../content/images/size/w300/2022/01/vlcsnap-2022-01-30-00h01m19s402.png" loading="lazy" alt="">
                                    </div>
                                    <h3 class="m-recent-article__title js-recent-article-title" title="Neural Chip Design [3/4: RTL Design &amp; Verification]">
                                      Neural Chip Design [3/4: RTL Design &amp; Verification]
                                    </h3>
                                    <span class="m-recent-article__date">a month ago</span>
                                  </a>
                                </div>
                                <div class="glide__slide">
                                  <a href="../dnn-to-chip-2/index.html" class="m-recent-article">
                                    <div class="m-recent-article__picture ">
                                        <img src="../content/images/size/w300/2022/01/b6f87d_cec29645262b492f95a30c10edec1090_mv2.jpg" loading="lazy" alt="">
                                    </div>
                                    <h3 class="m-recent-article__title js-recent-article-title" title="Neural Chip Design [2/4: Golden Model]">
                                      Neural Chip Design [2/4: Golden Model]
                                    </h3>
                                    <span class="m-recent-article__date">a month ago</span>
                                  </a>
                                </div>
                                <div class="glide__slide">
                                  <a href="../dnn-to-chip-1/index.html" class="m-recent-article">
                                    <div class="m-recent-article__picture ">
                                        <img src="../content/images/size/w300/2022/01/cov-14.jpg" loading="lazy" alt="">
                                    </div>
                                    <h3 class="m-recent-article__title js-recent-article-title" title="Neural Chip Design [1/4: Overview]">
                                      Neural Chip Design [1/4: Overview]
                                    </h3>
                                    <span class="m-recent-article__date">a month ago</span>
                                  </a>
                                </div>
                              </div>
                            </div>
                          </div>
                    </section>
                    <section class="m-tags">
                      <h3 class="m-submenu-title">Tags</h3>
                        <ul>
                            <li>
                              <a href="../tag/australia/index.html">Australia</a>
                            </li>
                            <li>
                              <a href="../tag/community-work/index.html">Community Work</a>
                            </li>
                            <li>
                              <a href="../tag/india/index.html">India</a>
                            </li>
                            <li>
                              <a href="../tag/nature/index.html">Nature</a>
                            </li>
                            <li>
                              <a href="../tag/reviews/index.html">Reviews</a>
                            </li>
                            <li>
                              <a href="../tag/stories/index.html">Stories</a>
                            </li>
                            <li>
                              <a href="../tag/teaching/index.html">Teaching</a>
                            </li>
                            <li>
                              <a href="../tag/tech-projects/index.html">Technical Projects</a>
                            </li>
                            <li>
                              <a href="../tag/thoughts/index.html">Thoughts</a>
                            </li>
                            <li>
                              <a href="../tag/travels/index.html">Travels</a>
                            </li>
                        </ul>
                    </section>
                  </div>
                </div>
              </li>
            </ul>
          </nav>
          <div class="m-nav__right">
            <button class="m-icon-button in-menu-main js-open-search" aria-label="Open search">
              <span class="icon-search" aria-hidden="true"></span>
            </button>
            <div class="m-toggle-darkmode js-tooltip" data-tippy-content="Toggle light/dark mode" tabindex="0">
              <label for="toggle-darkmode" class="sr-only">
                Toggle light/dark mode
              </label>
              <input id="toggle-darkmode" type="checkbox" class="js-toggle-darkmode">
              <div>
                <span class="icon-moon moon" aria-hidden="true"></span>
                <span class="icon-sunny sun" aria-hidden="true"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</header>

<main class="main-wrap">
    
  <section class="m-hero with-picture" data-aos="fade">
    <div class="m-hero__picture in-post">
      <img srcset="../content/images/size/w300/2022/01/vlcsnap-2022-01-30-00h01m19s402.png 300w, ../content/images/size/w600/2022/01/vlcsnap-2022-01-30-00h01m19s402.png 600w, ../content/images/size/w1000/2022/01/vlcsnap-2022-01-30-00h01m19s402.png 1000w, ../content/images/size/w2000/2022/01/vlcsnap-2022-01-30-00h01m19s402.png 2000w" sizes="(max-width: 600px) 600px, (max-width: 1000px) 1000px, 2000px" src="../content/images/size/w2000/2022/01/vlcsnap-2022-01-30-00h01m19s402.png" alt="" />
    </div>
    </section>
  
  <article>
    <div class="l-content in-post">
        <div class="l-wrapper in-post  js-aos-wrapper" data-aos="fade-up"
          data-aos-delay="300">
          <div
            class="l-post-content js-progress-content">
            <header class="m-heading">
              <h1 class="m-heading__title in-post">Neural Chip Design [3/4: RTL Design &amp; Verification]</h1>
              <div class="m-heading__meta">
                  <a href="../tag/tech-projects/index.html" class="m-heading__meta__tag">Technical Projects</a>
                  <span class="m-heading__meta__divider" aria-hidden="true">&bull;</span>
                <span class="m-heading__meta__time">Jan 29, 2022</span>
              </div>
            </header>
            <div class="pos-relative js-post-content">
              <div class="m-share">
                <div class="m-share__content js-sticky">
                  <a href="https://www.facebook.com/sharer/sharer.php?u=https://aba-blog.xyz/dnn-to-chip-3/"
                    class="m-icon-button filled in-share" target="_blank" rel="noopener" aria-label="Facebook">
                    <span class="icon-facebook" aria-hidden="true"></span>
                  </a>
                  <a href="https://twitter.com/intent/tweet?text=Neural%20Chip%20Design%20%5B3%2F4%3A%20RTL%20Design%20%26%20Verification%5D&url=https://aba-blog.xyz/dnn-to-chip-3/"
                    class="m-icon-button filled in-share" target="_blank" rel="noopener" aria-label="Twitter">
                    <span class="icon-twitter" aria-hidden="true"></span>
                  </a>
                  <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://aba-blog.xyz/dnn-to-chip-3/"
                    class="m-icon-button filled in-share" target="_blank" rel="noopener" aria-label="LinkedIn">
                    <span class="icon-linkedin" aria-hidden="true"></span>
                  </a>
                  <a href="https://reddit.com/submit?url=https://aba-blog.xyz/dnn-to-chip-3/&title=Neural%20Chip%20Design%20%5B3%2F4%3A%20RTL%20Design%20%26%20Verification%5D"
                    class="m-icon-button filled in-share" target="_blank" rel="noopener" aria-label="Reddit">
                    <span class="icon-reddit" aria-hidden="true"></span>
                  </a>
                  <button class="m-icon-button filled in-share progress js-scrolltop" aria-label="Scroll to top">
                    <span class="icon-arrow-top" aria-hidden="true"></span>
                    <svg aria-hidden="true">
                      <circle class="progress-ring__circle js-progress" fill="transparent" r="0" />
                    </svg>
                  </button>
                </div>
              </div>
              <blockquote>This is a series of articles <a href="https://aba-blog.xyz/dnn-to-chip-1/index.html">[overview]</a> outlining the  workflow of 15 steps, which I developed over the past few years through building my own DNN accelerator: Kraken<a href="https://arxiv.org/abs/2112.02793"> [arXiv paper]</a>.</blockquote><p>After building golden models and understanding the operations, its time to design and implement digital circuits that can accelerate those operations with: </p><ul><li>low on-chip area</li><li>high fmax (hence short critical paths)</li><li>minimal multiplexers, registers, and SRAM usage</li></ul><p>For this, I first design my modules in detail, on a whiteboard. I spend days or weeks doing this: optimizing designs and mapping out state machines for each module. Once I'm satisfied. I sit with VSCode and start writing synthesizable RTL. Once I'm done, I generate test vectors from the golden model, write testbenches to read and compare them and start debugging.</p><h2 id="steps">Steps:</h2><!--kg-card-begin: markdown--><ol start="3">
<li><strong>Whiteboard</strong>: Design hardware</li>
<li><strong>RTL Design</strong>: SystemVerilog/Verilog for the whiteboard designs</li>
<li><strong>Generate Test Vectors</strong>: using Python Notebooks</li>
<li><strong>Testbenches</strong>: SystemVerilog OOP testbenches to read the input vector (txt file), randomly control the valid &amp; ready signals and get output vectors (txt files)</li>
<li><strong>Debug</strong>: Python notebooks to compare the expected output with simulation output and to find which dimensions have errors.</li>
<li><strong>Microsoft Excel</strong>: I manually simulate the values in wires with excel to debug</li>
<li>Repeat 3-8: For every module &amp; every level of integration</li>
<li><strong>ASIC Synthesis</strong></li>
</ol>
<!--kg-card-end: markdown--><div class="kg-card kg-header-card kg-width-full kg-size-small kg-style-dark" style="" data-kg-background-image=""><h2 class="kg-header-card-header">3. Whiteboard</h2></div><p>I almost always design my modules fully on a whiteboard before sitting down to write RTL. This helps to map out almost every register and multiplexer, get an idea of the critical paths, and also to reduce bugs.</p><figure class="kg-card kg-gallery-card kg-width-wide"><div class="kg-gallery-container"><div class="kg-gallery-row"><div class="kg-gallery-image"><img src="../content/images/2022/01/Data-Flow-of-Inference-Engine-2.png" width="2000" height="1042" loading="lazy" alt srcset="../content/images/size/w600/2022/01/Data-Flow-of-Inference-Engine-2.png 600w, ../content/images/size/w1000/2022/01/Data-Flow-of-Inference-Engine-2.png 1000w, ../content/images/size/w1600/2022/01/Data-Flow-of-Inference-Engine-2.png 1600w, ../content/images/size/w2400/2022/01/Data-Flow-of-Inference-Engine-2.png 2400w" sizes="(min-width: 720px) 720px"></div><div class="kg-gallery-image"><img src="../content/images/2022/01/pixel-rot-with-bram.png" width="2000" height="2312" loading="lazy" alt srcset="../content/images/size/w600/2022/01/pixel-rot-with-bram.png 600w, ../content/images/size/w1000/2022/01/pixel-rot-with-bram.png 1000w, ../content/images/size/w1600/2022/01/pixel-rot-with-bram.png 1600w, ../content/images/size/w2400/2022/01/pixel-rot-with-bram.png 2400w" sizes="(min-width: 720px) 720px"></div><div class="kg-gallery-image"><img src="../content/images/2022/01/New-Doc-2019-09-12-20.33.10.jpg" width="2000" height="1295" loading="lazy" alt srcset="../content/images/size/w600/2022/01/New-Doc-2019-09-12-20.33.10.jpg 600w, ../content/images/size/w1000/2022/01/New-Doc-2019-09-12-20.33.10.jpg 1000w, ../content/images/size/w1600/2022/01/New-Doc-2019-09-12-20.33.10.jpg 1600w, ../content/images/size/w2400/2022/01/New-Doc-2019-09-12-20.33.10.jpg 2400w" sizes="(min-width: 720px) 720px"></div></div><div class="kg-gallery-row"><div class="kg-gallery-image"><img src="../content/images/2022/01/IMG_20191209_091223.jpg" width="2000" height="1500" loading="lazy" alt srcset="../content/images/size/w600/2022/01/IMG_20191209_091223.jpg 600w, ../content/images/size/w1000/2022/01/IMG_20191209_091223.jpg 1000w, ../content/images/size/w1600/2022/01/IMG_20191209_091223.jpg 1600w, ../content/images/size/w2400/2022/01/IMG_20191209_091223.jpg 2400w" sizes="(min-width: 720px) 720px"></div><div class="kg-gallery-image"><img src="../content/images/2022/01/Adobe-Scan-Jun-16--2021.png" width="2000" height="1107" loading="lazy" alt srcset="../content/images/size/w600/2022/01/Adobe-Scan-Jun-16--2021.png 600w, ../content/images/size/w1000/2022/01/Adobe-Scan-Jun-16--2021.png 1000w, ../content/images/size/w1600/2022/01/Adobe-Scan-Jun-16--2021.png 1600w, ../content/images/size/w2400/2022/01/Adobe-Scan-Jun-16--2021.png 2400w" sizes="(min-width: 720px) 720px"></div><div class="kg-gallery-image"><img src="../content/images/2022/01/LRELU-engine.png" width="2000" height="1350" loading="lazy" alt srcset="../content/images/size/w600/2022/01/LRELU-engine.png 600w, ../content/images/size/w1000/2022/01/LRELU-engine.png 1000w, ../content/images/size/w1600/2022/01/LRELU-engine.png 1600w, ../content/images/size/w2400/2022/01/LRELU-engine.png 2400w" sizes="(min-width: 720px) 720px"></div></div><div class="kg-gallery-row"><div class="kg-gallery-image"><img src="../content/images/2022/01/Pad-filter-1.png" width="2000" height="1353" loading="lazy" alt srcset="../content/images/size/w600/2022/01/Pad-filter-1.png 600w, ../content/images/size/w1000/2022/01/Pad-filter-1.png 1000w, ../content/images/size/w1600/2022/01/Pad-filter-1.png 1600w, ../content/images/size/w2400/2022/01/Pad-filter-1.png 2400w" sizes="(min-width: 720px) 720px"></div><div class="kg-gallery-image"><img src="../content/images/2022/01/Quantization-scheme-1.png" width="2000" height="1968" loading="lazy" alt srcset="../content/images/size/w600/2022/01/Quantization-scheme-1.png 600w, ../content/images/size/w1000/2022/01/Quantization-scheme-1.png 1000w, ../content/images/size/w1600/2022/01/Quantization-scheme-1.png 1600w, ../content/images/size/w2400/2022/01/Quantization-scheme-1.png 2400w" sizes="(min-width: 720px) 720px"></div><div class="kg-gallery-image"><img src="../content/images/2022/01/Weights-Rotator.png" width="2000" height="2031" loading="lazy" alt srcset="../content/images/size/w600/2022/01/Weights-Rotator.png 600w, ../content/images/size/w1000/2022/01/Weights-Rotator.png 1000w, ../content/images/size/w1600/2022/01/Weights-Rotator.png 1600w, ../content/images/size/w2400/2022/01/Weights-Rotator.png 2400w" sizes="(min-width: 720px) 720px"></div></div></div></figure><div class="kg-card kg-header-card kg-width-full kg-size-small kg-style-dark" style="" data-kg-background-image=""><h2 class="kg-header-card-header">4. RTL Design</h2><h3 class="kg-header-card-subheader">SystemVerilog / Verilog</h3></div><p>I then start writing modules, state-machines...etc. using synthesizable SystemVerilog, converting my whiteboard drawings into code. This is fairly straightforward. I've given a stripped-down example code of my conv engine. The key things to note are:</p><ul><li><strong>SystemVerilog </strong>- Verilog lacks a lot of features and has the potential to cause serious bugs. SystemVerilog is beautiful and a breeze to write and read.</li><li><strong>Multidimensional wires and ports</strong> - I use them a lot, to group ports meaningfully and connect with each other. I prefer packed over unpacked, so multidimensional SystemVerilog ports can be seamlessly connected to Verilog wrappers with flat ports, without having to manually flatten them.</li><li> <strong>Readability </strong>- I take this seriously. Order does not matter in HDL, but I write in a way that the code top to bottom corresponds to left to right in my whiteboard diagram (the way signal flows).</li><li><strong>Macro Parameters</strong> - I put all the parameters, derived parameters in a common file and include it in all modules. That file itself is written through a tcl script. This way, the parameters of all files are guaranteed to be the same, avoiding bugs and also making the code readable.</li><li><strong>No always@clk</strong>: This might be a surprise. In my entire synthesizable codebase of 9000 lines, I have only one sequential always block: in a parametrized module named <em>register.v.</em>  The register module has optional clken, different types of reset...etc. All other modules instantiate this whenever needed. This helps me to avoid bugs, and to visualize the signal flow, as it directly translates from my whiteboard to code.</li><li><strong>FPGA &amp; ASIC</strong> - Using preprocessor directives (`ifdef), I write code to suit both FPGA and ASIC. Registers have async reset in ASIC mode and sync reset in FPGA mode.</li></ul><pre><code class="language-verilog">`timescale 1ns/1ps
`include "../include/params.v"

module conv_engine #(ZERO=0) (
    clk            ,
    clken          ,
    resetn         ,
    s_valid        ,
    s_ready        ,
    s_last         ,
    s_user         ,
    s_data_pixels  ,
    s_data_weights ,
    m_valid        ,
    m_data         ,
    m_last         ,
    m_user         
  );
  input  logic clk, clken, resetn;
  input  logic s_valid, s_last;
  output logic s_ready;
  output logic m_valid, m_last;
  input  logic [`TUSER_WIDTH_CONV_IN-1:0] s_user;
  input  logic [`COPIES-1:0][`UNITS -1:0]                          [`WORD_WIDTH_IN    -1:0] s_data_pixels;
  input  logic [`COPIES-1:0][`GROUPS-1:0][`MEMBERS-1:0]            [`WORD_WIDTH_IN    -1:0] s_data_weights;                                                                        
  output logic [`COPIES-1:0][`GROUPS-1:0][`MEMBERS-1:0][`UNITS-1:0][`WORD_WIDTH_OUT   -1:0] m_data;
  output logic [`TUSER_WIDTH_CONV_OUT-1:0] m_user;
  
  // Code ommited
  logic [`KW_MAX/2:0][`SW_MAX -1:0][`MEMBERS -1:0] lut_sum_start;
  logic [`COPIES-1:0][`GROUPS-1:0][`MEMBERS-1:0][`UNITS-1:0][`WORD_WIDTH_IN*2-1:0] mul_m_data ;
  logic [`COPIES-1:0][`GROUPS-1:0][`MEMBERS-1:0][`UNITS-1:0][`WORD_WIDTH_OUT -1:0] acc_s_data ;
  logic [`COPIES-1:0][`GROUPS-1:0][`MEMBERS-1:0][`UNITS-1:0][`WORD_WIDTH_OUT -1:0] mux_s2_data;

  generate
    genvar c,g,u,m,b,kw2,sw_1;
    // Code ommitted
    for (c=0; c &lt; `COPIES; c++)
      for (g=0; g &lt; `GROUPS; g++)
        for (u=0; u &lt; `UNITS; u++)
          for (m=0; m &lt; `MEMBERS; m++)
            if (m==0) assign mux_s2_data [c][g][m][u] = 0;
            else      assign mux_s2_data [c][g][m][u] = m_data     [c][g][m-1][u];
    assign mux_sel_next = mul_m_valid &amp;&amp; mul_m_user[`I_IS_CIN_LAST] &amp;&amp; (mul_m_kw2 != 0);

    register #(
      .WORD_WIDTH     (1),
      .RESET_VALUE    (0)
    ) MUX_SEL (
      .clock          (clk   ),
      .resetn         (resetn),
      .clock_enable   (clken ),
      .data_in        (mux_sel_next),
      .data_out       (mux_sel )
    );
    assign clken_mul = clken &amp;&amp; !mux_sel;
            
    for (m=0; m &lt; `MEMBERS; m++) begin: Mb
      for (kw2=0; kw2 &lt;= `KW_MAX/2; kw2++)
        for (sw_1=0; sw_1 &lt; `SW_MAX; sw_1++) begin
          localparam k = kw2*2 + 1;
          localparam s = sw_1 + 1;
          localparam j = k + s -1;

          assign lut_sum_start[kw2][sw_1][m] = m % j &lt; s; // m % 3 &lt; 1 : 0,1
        end
      assign acc_m_sum_start [m] = lut_sum_start[acc_m_kw2][acc_m_sw_1][m] &amp; acc_m_user[`I_IS_SUM_START];
      // Code ommited
    end

    for (c=0; c &lt; `COPIES; c++) begin: Ca
      for (g=0; g &lt; `GROUPS; g++) begin: Ga
        for (u=0; u &lt; `UNITS; u++) begin: Ua
          for (m=0; m &lt; `MEMBERS; m++) begin: Ma
            processing_element PROCESSING_ELEMENT (
              .clk           (clk           ),
              .clken         (clken         ),
              .resetn        (resetn        ),
              .clken_mul     (clken_mul     ),
              .s_data_pixels (s_data_pixels [c]      [u]), 
              .s_data_weights(s_data_weights[c][g][m]   ),
              .mul_m_data    (mul_m_data    [c][g][m][u]),
              .mux_sel       (mux_sel       ),
              .mux_s2_data   (mux_s2_data   [c][g][m][u]),
              .bypass        (bypass        [m]),
              .clken_acc     (clken_acc     [m]),
              .acc_s_data    (acc_s_data    [c][g][m][u]),
              .m_data        (m_data        [c][g][m][u])
            );
    end end end end

    // Code ommitted
    assign m_user_base[`I_IS_BOTTOM_BLOCK:`I_IS_NOT_MAX] = acc_m_user[`I_IS_BOTTOM_BLOCK:`I_IS_NOT_MAX];
    assign m_user  = {m_clr, m_shift_b, m_shift_a, m_user_base};
  endgenerate
endmodule</code></pre><pre><code class="language-verilog">module processing_element (
    clk    ,
    clken  ,
    resetn ,

    clken_mul,
    s_data_pixels, 
    s_data_weights,
    mul_m_data,

    mux_sel,
    mux_s2_data,
    bypass,
    clken_acc,
    acc_s_data,
    m_data
  );
  input  logic clk, clken, resetn;
  input  logic clken_mul, mux_sel, bypass, clken_acc;
  input  logic [`WORD_WIDTH_IN  -1:0] s_data_pixels, s_data_weights;
  input  logic [`WORD_WIDTH_OUT -1:0] mux_s2_data;
  output logic [`WORD_WIDTH_IN*2-1:0] mul_m_data;
  output logic [`WORD_WIDTH_OUT -1:0] acc_s_data;
  output logic [`WORD_WIDTH_OUT -1:0] m_data;

`ifdef MAC_XILINX
  multiplier MUL (
`else
  multiplier_raw MUL (
`endif
    .CLK    (clk),
    .CE     (clken_mul),
    .A      (s_data_pixels ),
    .B      (s_data_weights),
    .P      (mul_m_data    )
  );
  assign acc_s_data = mux_sel ? mux_s2_data  : `WORD_WIDTH_OUT'(signed'(mul_m_data));
  
`ifdef MAC_XILINX
  accumulator ACC (
`else
  accumulator_raw ACC (
`endif
    .CLK    (clk),  
    .bypass (bypass     ),  
    .CE     (clken_acc  ),  
    .B      (acc_s_data ),  
    .Q      (m_data     )  
  );
endmodule</code></pre><p></p><div class="kg-card kg-header-card kg-width-full kg-size-small kg-style-dark" style="" data-kg-background-image=""><h2 class="kg-header-card-header">5. Test Vector Generation</h2><h3 class="kg-header-card-subheader">Python</h3></div><p>Next, I write python functions to extracts weights and inputs of each layer from my custom framework model (2.2), and convert them into input test vectors. Their dimensions need to be split, reshaped, transposed and flattened to get the final input \(\hat{X}\), and weights \(\hat{K}\) packets which can be understood by the hardware I designed. Output \(\hat{Y}\) is also transformed to match the hardware's outputs. Also, configuration bits need to be calculated and appended to the packet to make it complete.</p><figure class="kg-card kg-gallery-card kg-width-wide kg-card-hascaption"><div class="kg-gallery-container"><div class="kg-gallery-row"><div class="kg-gallery-image"><img src="../content/images/2022/01/reshape.png" width="1088" height="1305" loading="lazy" alt srcset="../content/images/size/w600/2022/01/reshape.png 600w, ../content/images/size/w1000/2022/01/reshape.png 1000w, ../content/images/2022/01/reshape.png 1088w" sizes="(min-width: 720px) 720px"></div><div class="kg-gallery-image"><img src="../content/images/2022/01/reshape2.png" width="1074" height="1590" loading="lazy" alt srcset="../content/images/size/w600/2022/01/reshape2.png 600w, ../content/images/size/w1000/2022/01/reshape2.png 1000w, ../content/images/2022/01/reshape2.png 1074w" sizes="(min-width: 720px) 720px"></div></div></div><figcaption>The python functions perform these reshapes to generate input and output vectors (multidimensional tensors)</figcaption></figure><pre><code class="language-python">def get_weights(i_layers, i_itr, c):
    weights = c.LAYERS[f'{c.PREFIX_CONV}{i_layers}'].weights
    KH, KW, CIN, COUT = weights.shape
    max_factor = 2 if f'{c.PREFIX_MAX}{i_layers}' in c.LAYERS.keys() else 1
    print(f"get_weights - shape_in:(KH, KW, CIN, COUT) = {weights.shape}")
    
    '''
    Reshape
    '''
    weights = weights.transpose(3,0,1,2) #(COUT,KH,KW,CIN)
    weights = fill_invalid_scg(weights,KW=KW,max_factor=max_factor,c=c) #(ITR,EFF_CORES,KH,KW,CIN)
    ITR,EFF_CORES = weights.shape[0:2]
    weights = weights.transpose(0,4,2,1,3) #(ITR,CIN,KH,EFF_CORES,KW)

    '''
    * Data comes out of maxpool in the order: S,CGU
    * Data comes out of conv in the order   : CGMU and is transposed into S,CGUby hardware
    * Conv in takes weights in order        : CGM

    * Since system_out is SCG, first invalid should be filled that way, so that output data is continous and cin matches cout
    * After filling, we transpose it to CGM
    '''
    SUB_CORES = c.MEMBERS//KW
    weights = weights.reshape((ITR,CIN,KH, SUB_CORES,c.COPIES//max_factor,c.GROUPS ,KW)) # EFF_CORES = (SCG)
    weights = weights.transpose(0,1,2, 4,5, 3,6) # CGS
    weights = weights.reshape((ITR,CIN,KH,1,c.COPIES//max_factor,c.GROUPS,SUB_CORES,KW)) # (CGS)
    weights = np.repeat(weights,repeats=max_factor,axis=3)
    weights = weights.reshape((ITR,CIN,KH,c.COPIES,c.GROUPS,SUB_CORES,KW))
    weights = weights.reshape((ITR,CIN,KH,c.COPIES,c.GROUPS,SUB_CORES*KW))
    zeros = np.zeros((ITR,CIN,KH,c.COPIES,c.GROUPS,c.MEMBERS), dtype=weights.dtype)
    zeros[:,:,:,:,:,0:SUB_CORES*KW] = weights
    weights = zeros

    KERNEL_BEATS = CIN*KH
    weights = weights.reshape(ITR,KERNEL_BEATS,c.COPIES,c.GROUPS,c.MEMBERS)

    '''
    Add LRELU Beats
    '''
    lrelu = get_lrelu_config(i_layers=i_layers,c=c) 
        
    LRELU_BEATS = lrelu.shape[1]
    weights_beats = np.concatenate([lrelu,weights], axis=1) # (ITR, LRELU_BEATS + KERNEL_BEATS, COPIES, GROUPS, MEMBERS)

    _,H,W,CIN = c.LAYERS[f'{c.PREFIX_CONV}{i_layers}'].in_data.shape
    BLOCKS    = H // (SH*max_factor*c.CONV_UNITS)

    bram_weights_addr_max = LRELU_BEATS + SW*KH*CIN-1
    print("bram_weights_addr_max: ", bram_weights_addr_max)

    weights_config = 0
    weights_config |= (KW//2)
    weights_config |= (KH//2)               &lt;&lt; (BITS_KW2)
    weights_config |= SW-1                  &lt;&lt; (BITS_KW2 + BITS_KH2)
    weights_config |= (CIN   -1)            &lt;&lt; (BITS_KW2 + BITS_KH2 + BITS_SW)
    weights_config |= (W     -1)            &lt;&lt; (BITS_KW2 + BITS_KH2 + BITS_SW + BITS_CIN_MAX)
    weights_config |= (BLOCKS-1)            &lt;&lt; (BITS_KW2 + BITS_KH2 + BITS_SW + BITS_CIN_MAX + BITS_COLS_MAX)
    weights_config |= bram_weights_addr_max &lt;&lt; (BITS_KW2 + BITS_KH2 + BITS_SW + BITS_CIN_MAX + BITS_COLS_MAX + BITS_BLOCKS_MAX)

    weights_config = np.frombuffer(np.uint64(weights_config).tobytes(),np.int8)
    weights_config = np.repeat(weights_config[np.newaxis,...],repeats=ITR,axis=0)

    '''
    ADD c BEATS
    '''
    weights_dma_beats = np.concatenate([weights_config,weights_beats.reshape(ITR,-1)], axis=1)

    assert weights_dma_beats.shape == (ITR, 8 + (LRELU_BEATS + CIN*KH*SW)*c.COPIES*c.GROUPS*c.MEMBERS)
    print(f"get_weights - weights_dma_beats.shape: (ITR, 4 + (LRELU_BEATS + CIN*KH)*COPIES*GROUPS*MEMBERS) = {weights_dma_beats.shape}")

    np.savetxt(f"{c.DATA_DIR}{i_layers}_weights.txt", weights_dma_beats[i_itr].flatten(), fmt='%d')
    return weights_dma_beats</code></pre><p></p><div class="kg-card kg-header-card kg-width-full kg-size-small kg-style-dark" style="" data-kg-background-image=""><h2 class="kg-header-card-header">6. Testbench &amp; Simulation</h2><h3 class="kg-header-card-subheader">SystemVerilog</h3></div><p>Next, I write testbenches for the modules. They are built around two custom SystemVerilog classes: AXIS_Slave, which reads a text file and loads data into an AXI stream port while conforming to the protocol, and AXIS_Master which reads data from a port and writes into a text file. </p><figure class="kg-card kg-embed-card"><iframe width="200" height="113" src="https://www.youtube.com/embed/jZIaMTLCzjc?feature=oembed" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></figure><p>The control signals: valid and ready are randomized. They get toggled according to a given probability, to simulate the effects of memory bus freezing up and clearing.</p><figure class="kg-card kg-code-card"><pre><code class="language-verilog">`timescale 1ns/1ps
class AXIS_Slave #(WORD_WIDTH=8, WORDS_PER_BEAT=1, VALID_PROB=100);

  string file_path;
  int words_per_packet, status, iterations, i_words;
  int file = 0;
  int i_itr = 0;
  bit enable = 0;
  bit first_beat = 1;

  rand bit s_valid;
  constraint c { s_valid dist { 0 := (100-VALID_PROB), 1 := (VALID_PROB)}; };

  function new(string file_path, int words_per_packet, int iterations);
    this.file_path = file_path;
    this.words_per_packet = words_per_packet;
    this.iterations = iterations;
    this.file = $fopen(this.file_path, "r");
  endfunction

  function void fill_beat(
    ref logic [WORDS_PER_BEAT-1:0][WORD_WIDTH-1:0] s_data, 
    ref logic [WORDS_PER_BEAT-1:0] s_keep,
    ref logic s_last);

    if($feof(file)) $fatal(1, "EOF found\n");
    if (first_beat) first_beat = 0;

    for (int i=0; i &lt; WORDS_PER_BEAT; i++) begin
      status = $fscanf(file,"%d\n", s_data[i]);
      s_keep[i] = i_words &lt; words_per_packet;
      i_words  += 1;
    end
    if(i_words &gt;= words_per_packet)
      s_last = 1;
  endfunction

  function void reset(
    ref logic s_valid,
    ref logic [WORDS_PER_BEAT-1:0][WORD_WIDTH-1:0] s_data, 
    ref logic [WORDS_PER_BEAT-1:0] s_keep,
    ref logic s_last
  );
    enable = 0;
    s_data = '{default:0};
    s_valid = 0;
    s_keep = 0;
    s_last = 0;
    first_beat = 1;
    i_words = 0;

    if (file != 0) $fclose(file);
    file = $fopen(file_path, "r");
  endfunction

  task axis_feed(
    ref logic aclk,
    ref logic s_ready,
    ref logic s_valid,
    ref logic [WORDS_PER_BEAT-1:0][WORD_WIDTH-1:0] s_data, 
    ref logic [WORDS_PER_BEAT-1:0] s_keep,
    ref logic s_last
  );
    // Before beginning: set all signals zero
    if (~enable) begin
      this.reset(s_valid, s_data, s_keep, s_last);
      @(posedge aclk);
      return;
    end

    @(posedge aclk);
    this.randomize(); // random this.s_valid at every cycle
    if (s_ready &amp;&amp; (first_beat ? this.s_valid : s_valid)) begin
      // If s_last has passed with handshake, packet done. start next itr
      if(s_last) begin #1;
        i_itr += 1;
        this.reset(s_valid, s_data, s_keep, s_last);

        if (i_itr &lt; iterations) 
          enable = 1;
        else begin
          $fclose(file);
          return;
        end
      end
      else #1;

      // If file is not open, keep valid down.
      if(file == 0) begin
        s_valid = 0;
        return;
      end
      else this.fill_beat(s_data, s_keep, s_last);
    end
    else #1;

    if (~first_beat) s_valid = this.s_valid;
  endtask
endclass</code></pre><figcaption>Stripped down version of AXIS_Slave class</figcaption></figure><p>Following is an example on how AXIS slave and master classes are utilized. Each module gets a testbench like this. Some modules get multiple slave and multiple masters.</p><pre><code class="language-verilog">module axis_tb_demo();
  timeunit 1ns;
  timeprecision 1ps;
  localparam CLK_PERIOD = 10;
  logic aclk;
  initial begin
    aclk = 0;
    forever #(CLK_PERIOD/2) aclk &lt;= ~aclk;
  end

  localparam WORD_WIDTH        = 8;
  localparam WORDS_PER_PACKET  = 40;
  localparam WORDS_PER_BEAT    = 4;
  localparam ITERATIONS        = 6;
  localparam BEATS = int'($ceil(real'(WORDS_PER_PACKET)/real'(WORDS_PER_BEAT)));

  logic [WORDS_PER_BEAT  -1:0][WORD_WIDTH-1:0] data;
  logic [WORDS_PER_BEAT  -1:0] keep;
  logic valid, ready, last;

  string path = "D:/cnn-fpga/data/axis_test.txt";
  string out_base = "D:/cnn-fpga/data/axis_test_out_";

  AXIS_Slave #(
    .WORD_WIDTH    (WORD_WIDTH    ), 
    .WORDS_PER_BEAT(WORDS_PER_BEAT), 
    .VALID_PROB    (70            )
    ) slave_obj  = new(
      .file_path       (path), 
      .words_per_packet(WORDS_PER_PACKET), 
      .iterations      (ITERATIONS)
      );
  AXIS_Master #(
    .WORD_WIDTH    (WORD_WIDTH    ), 
    .WORDS_PER_BEAT(WORDS_PER_BEAT), 
    .READY_PROB    (70            ), 
    .CLK_PERIOD    (CLK_PERIOD    ),
    .IS_ACTIVE     (1             )
    ) master_obj = new(
      .file_base(out_base),
      .words_per_packet(-1),
      .packets_per_file(2)
      );
  initial forever  slave_obj.axis_feed(aclk, ready, valid, data, keep, last);
  initial forever master_obj.axis_read(aclk, ready, valid, data, keep, last);

  initial begin
    @(posedge aclk);
    slave_obj.enable &lt;= 1;
    master_obj.enable &lt;= 1;
  end

  int s_words, s_itr, m_words, m_itr, m_packets, m_packets_per_file;
  initial
    forever begin
      @(posedge aclk);
      s_words = slave_obj.i_words;
      s_itr = slave_obj.i_itr;
      m_words = master_obj.i_words;
      m_itr = master_obj.i_itr;
      m_packets = master_obj.i_packets;
      m_packets_per_file = master_obj.packets_per_file;
    end
endmodule</code></pre><div class="kg-card kg-header-card kg-width-full kg-size-small kg-style-dark" style="" data-kg-background-image=""><h2 class="kg-header-card-header">7. Debugging</h2><h3 class="kg-header-card-subheader">Python Notebooks &amp; SystemVerilog Simulations</h3></div><p>I then run simulations, collect output vectors and compare them with expected vectors using python notebooks. Notebooks allow one to play around with data, quickly print and observe different dimensions...etc. </p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="../content/images/2022/01/image-6.png" class="kg-image" alt loading="lazy" width="1134" height="759" srcset="../content/images/size/w600/2022/01/image-6.png 600w, ../content/images/size/w1000/2022/01/image-6.png 1000w, ../content/images/2022/01/image-6.png 1134w" sizes="(min-width: 720px) 720px"><figcaption>Integration testing the whole system</figcaption></figure><figure class="kg-card kg-image-card kg-card-hascaption"><img src="../content/images/2022/01/image-8.png" class="kg-image" alt loading="lazy" width="816" height="381" srcset="../content/images/size/w600/2022/01/image-8.png 600w, ../content/images/2022/01/image-8.png 816w" sizes="(min-width: 720px) 720px"><figcaption>Observing outputs</figcaption></figure><figure class="kg-card kg-image-card kg-card-hascaption"><img src="../content/images/2022/01/image-9.png" class="kg-image" alt loading="lazy" width="464" height="276"><figcaption>The dimension indices of the locations where output doesn't match expected output. Very helpful in debugging.</figcaption></figure><div class="kg-card kg-header-card kg-width-full kg-size-small kg-style-dark" style="" data-kg-background-image=""><h2 class="kg-header-card-header">8. Debugging with Microsoft Excel</h2><h3 class="kg-header-card-subheader">Yep :-)</h3></div><p>In some cases, the output from a module is garbage and does not match the expected output at all. Since it is a convolution over several values, it is near impossible to guess the bug by looking at such garbage numbers. In that case, I resort to Excel, where I manually transform a set of small input vectors through the logic, step by step to see what I should expect in every clock cycle. I then compare it to the waveforms I see in the simulator to figure out where the bug is.</p><figure class="kg-card kg-image-card"><img src="../content/images/2022/01/image-13.png" class="kg-image" alt loading="lazy" width="1920" height="932" srcset="../content/images/size/w600/2022/01/image-13.png 600w, ../content/images/size/w1000/2022/01/image-13.png 1000w, ../content/images/size/w1600/2022/01/image-13.png 1600w, ../content/images/2022/01/image-13.png 1920w" sizes="(min-width: 720px) 720px"></figure><div class="kg-card kg-header-card kg-width-full kg-size-small kg-style-dark" style="" data-kg-background-image=""><h2 class="kg-header-card-header">9. Repeat</h2></div><p>I move back and forth between the whiteboard, RTL code, python code, and simulation to fix bugs one by one. Some take weeks and make me want to pull my hair out. I also do this for each module, then put them together hierarchically, write integration testbenches, and test that too. </p><div class="kg-card kg-header-card kg-width-full kg-size-small kg-style-dark" style="" data-kg-background-image=""><h2 class="kg-header-card-header">10. ASIC Synthesis</h2></div><p>Once the design is verified in randomized simulations, I write the scripts for ASIC synthesis. Our university uses Cadence tools, so the following script is for Cadence Genus, using 65nm CMOS PDK from TSMC.</p><pre><code class="language-tcl">set TOP axis_accelerator_asic
# set TOP axis_conv_engine

#--------- CONFIG
set RTL_DIR ../../rtl
set XILINX 0
source ../../tcl/config.tcl
set_db hdl_max_loop_limit 10000000

set TECH 65nm
set NUM_MACS [expr $MEMBERS*$UNITS*$GROUPS*$COPIES]
set REPORT_DIR ../report/${TECH}/${TOP}/${NUM_MACS}
exec mkdir -p $REPORT_DIR

#--------- LIBRARIES
set LIB_DIR ../../../tsmc/${TECH}/GP
set_db library [glob $LIB_DIR/cc_lib/noise_scadv10_cln65gp_hvt_tt_1p0v_25c.lib $LIB_DIR/cc_lib/scadv10_cln65gp_hvt_tt_1p0v_25c.lib]
set_db lef_library [glob $LIB_DIR/lef/tsmc_cln65_a10_6X1Z_tech.lef $LIB_DIR/lef/tsmc_cln65_a10_6X2Z_tech.lef $LIB_DIR/lef/tsmc65_hvt_sc_adv10_macro.lef]
set_db qrc_tech_file $LIB_DIR/other/icecaps.tch
# set LIB_DIR ../../../tsmc/${TECH}/LP
# set_db library [glob $LIB_DIR/lib/sc12_cln65lp_base_hvt_tt_typical_max_1p00v_25c.lib $LIB_DIR/lib/sc12_cln65lp_base_hvt_tt_typical_max_1p20v_25c.lib]
# set_db lef_library [glob $LIB_DIR/lef/sc12_cln65lp_base_hvt.lef]

#--------- READ
read_hdl -mixvlog [glob $RTL_DIR/include/*]
read_hdl -mixvlog [glob $RTL_DIR/external/*]
read_hdl -mixvlog [glob $RTL_DIR/src/*]

#--------- ELABORATE &amp; CHECK
set_db lp_insert_clock_gating true
elaborate $TOP
check_design &gt; ${REPORT_DIR}/check_design.log
uniquify $TOP

#--------- CONSTRAINTS
set PERIOD [expr 1000.0/$FREQ_HIGH]
create_clock -name aclk -period $PERIOD [get_ports aclk]
set_dont_touch_network [all_clocks]
set_dont_touch_network [get_ports {aresetn}]

set design_inputs [get_ports {m_axis_tready s_axis_pixels_tvalid s_axis_pixels_tlast s_axis_pixels_tdata s_axis_pixels_tkeep s_axis_weights_tvalid s_axis_weights_tlast s_axis_weights_tdata s_axis_weights_tkeep}]
set design_outputs [get_ports {s_axis_pixels_tready  s_axis_weights_tready m_axis_tvalid m_axis_tlast m_axis_tdata m_axis_tkeep}]

set_input_delay  [expr $PERIOD * 0.6] -clock aclk $design_inputs
set_output_delay [expr $PERIOD * 0.6] -clock aclk $design_outputs

#--------- RETIME OPTIONS
set_db retime_async_reset true
set_db design:${TOP} .retime true

#--------- SYNTHESIZE
set_db syn_global_effort high
syn_generic
syn_map
syn_opt

#--------- NETLIST
write -mapped &gt; ../output/${TOP}.v
write_sdc &gt; ../output/${TOP}.sdc

#--------- REPORTS
report_area &gt; ${REPORT_DIR}/area.log
report_gates &gt; ${REPORT_DIR}/gates.log
report_timing  -nworst 10 &gt; ${REPORT_DIR}/timing.log
report_congestion &gt; ${REPORT_DIR}/congestion.log
report_messages &gt; ${REPORT_DIR}/messages.log
report_hierarchy &gt; ${REPORT_DIR}/hierarchy.log
report_clock_gating &gt; ${REPORT_DIR}/clock_gating.log

build_rtl_power_models -clean_up_netlist
report_power &gt; ${REPORT_DIR}/power.log</code></pre><h2 id="next">Next:</h2><figure class="kg-card kg-bookmark-card"><a class="kg-bookmark-container" href="https://aba-blog.xyz/dnn-to-chip-4/index.html"><div class="kg-bookmark-content"><div class="kg-bookmark-title">Neural Chip Design [4/4: SoC Integration &amp; Firmware]</div><div class="kg-bookmark-description">SoC design involves integrating other IPs, automating projects with TCL, writing C++ firmware, and testing on PSoC hardware.</div><div class="kg-bookmark-metadata"><img class="kg-bookmark-icon" src="https://aba-blog.xyz/favicon.png" alt=""><span class="kg-bookmark-author">Aba&#x27;s Blog</span><span class="kg-bookmark-publisher">Abarajithan G</span></div></div><div class="kg-bookmark-thumbnail"><img src="https://aba-blog.xyz/content/images/size/w2000/2022/01/sys-4.jpg" alt=""></div></a></figure>
                <section class="m-tags in-post">
                  <h3 class="m-submenu-title">Tags</h3>
                  <ul>
                      <li>
                        <a href="../tag/tech-projects/index.html" title="Technical Projects">Technical Projects</a>
                      </li>
                  </ul>
                </section>
            </div>
          </div>
        </div>

          <section class="m-comments">
            <div class="l-wrapper in-comments">
              <div class="fb-comments" data-href="https://aba-blog.xyz/dnn-to-chip-3/" data-width="100%" data-numposts="10" data-colorscheme="light" style="background-color: white"></div>
            </div>
          </section>


          <section class="m-recommended">
            <div class="l-wrapper in-recommended">
              <h3 class="m-section-title in-recommended">Recommended for you</h3>
              <div class="m-recommended-articles">
                <div class="m-recommended-slider glide js-recommended-slider">
                  <div class="glide__track" data-glide-el="track">
                    <div class="glide__slides">
                      
    <div class="m-recommended-slider__item glide__slide">
  <article class="m-article-card  post tag-tech-projects">
    <div class="m-article-card__picture">
      <a href="../dnn-to-chip-4/index.html" class="m-article-card__picture-link" aria-hidden="true" tabindex="-1"></a>
        <img class="m-article-card__picture-background" src="../content/images/size/w600/2022/01/sys-4.jpg" loading="lazy" alt="">
      <a href="../author/aba/index.html" class="m-article-card__author js-tooltip" aria-label="Abarajithan G" data-tippy-content="Posted by Abarajithan G ">
          <div style="background-image: url(../content/images/size/w100/2021/11/im_large_vignette.jpg);"></div>
      </a>
    </div>
      <div class="m-article-card__info">
        <a href="../tag/tech-projects/index.html" class="m-article-card__tag">Technical Projects</a>
      <a href="../dnn-to-chip-4/index.html" class="m-article-card__info-link" aria-label="Neural Chip Design [4/4: SoC Integration &amp; Firmware]">
        <div>
          <h2 class="m-article-card__title js-article-card-title " title="Neural Chip Design [4/4: SoC Integration &amp; Firmware]">
            Neural Chip Design [4/4: SoC Integration &amp; Firmware]
          </h2>
        </div>
        <div class="m-article-card__timestamp">
          <span>a month ago</span>
          <span>&bull;</span>
          <span>10 min read</span>
        </div>
      </a>
    </div>
  </article>
    </div>
    <div class="m-recommended-slider__item glide__slide">
  <article class="m-article-card  post tag-tech-projects">
    <div class="m-article-card__picture">
      <a href="../dnn-to-chip-2/index.html" class="m-article-card__picture-link" aria-hidden="true" tabindex="-1"></a>
        <img class="m-article-card__picture-background" src="../content/images/size/w600/2022/01/b6f87d_cec29645262b492f95a30c10edec1090_mv2.jpg" loading="lazy" alt="">
      <a href="../author/aba/index.html" class="m-article-card__author js-tooltip" aria-label="Abarajithan G" data-tippy-content="Posted by Abarajithan G ">
          <div style="background-image: url(../content/images/size/w100/2021/11/im_large_vignette.jpg);"></div>
      </a>
    </div>
      <div class="m-article-card__info">
        <a href="../tag/tech-projects/index.html" class="m-article-card__tag">Technical Projects</a>
      <a href="../dnn-to-chip-2/index.html" class="m-article-card__info-link" aria-label="Neural Chip Design [2/4: Golden Model]">
        <div>
          <h2 class="m-article-card__title js-article-card-title " title="Neural Chip Design [2/4: Golden Model]">
            Neural Chip Design [2/4: Golden Model]
          </h2>
        </div>
        <div class="m-article-card__timestamp">
          <span>a month ago</span>
          <span>&bull;</span>
          <span>8 min read</span>
        </div>
      </a>
    </div>
  </article>
    </div>
    <div class="m-recommended-slider__item glide__slide">
  <article class="m-article-card  post tag-tech-projects featured">
    <div class="m-article-card__picture">
      <a href="../dnn-to-chip-1/index.html" class="m-article-card__picture-link" aria-hidden="true" tabindex="-1"></a>
        <img class="m-article-card__picture-background" src="../content/images/size/w600/2022/01/cov-14.jpg" loading="lazy" alt="">
      <a href="../author/aba/index.html" class="m-article-card__author js-tooltip" aria-label="Abarajithan G" data-tippy-content="Posted by Abarajithan G ">
          <div style="background-image: url(../content/images/size/w100/2021/11/im_large_vignette.jpg);"></div>
      </a>
        <a href="../dnn-to-chip-1/index.html" class="m-article-card__featured js-tooltip" data-tippy-content="Featured" aria-label="Featured">
          <span class="icon-star" aria-hidden="true"></span>
        </a>
    </div>
      <div class="m-article-card__info">
        <a href="../tag/tech-projects/index.html" class="m-article-card__tag">Technical Projects</a>
      <a href="../dnn-to-chip-1/index.html" class="m-article-card__info-link" aria-label="Neural Chip Design [1/4: Overview]">
        <div>
          <h2 class="m-article-card__title js-article-card-title " title="Neural Chip Design [1/4: Overview]">
            Neural Chip Design [1/4: Overview]
          </h2>
        </div>
        <div class="m-article-card__timestamp">
          <span>a month ago</span>
          <span>&bull;</span>
          <span>5 min read</span>
        </div>
      </a>
    </div>
  </article>
    </div>
                    </div>
                  </div>
                  <div data-glide-el="controls" class="glide__arrows js-controls">
                    <button data-glide-dir="<" class="m-icon-button filled in-recommended-articles glide-prev" aria-label="Previous">
                      <span class="icon-arrow-left" aria-hidden="true"></span>
                    </button>
                    <button data-glide-dir=">" class="m-icon-button filled in-recommended-articles glide-next" aria-label="Next">
                      <span class="icon-arrow-right" aria-hidden="true"></span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </section>
    </div>
  </article>
</main>



    
<div class="m-search js-search" role="dialog" aria-modal="true" aria-label="Search">
  <button class="m-icon-button outlined as-close-search js-close-search" aria-label="Close search">
    <span class="icon-close" aria-hidden="true"></span>
  </button>
  <div class="m-search__content">
    <form class="m-search__form">
      <div class="pos-relative">
        <span class="icon-search m-search-icon" aria-hidden="true"></span>
        <label for="search-input" class="sr-only">
          Type to search
        </label>
        <input id="search-input" type="text" class="m-input in-search js-input-search" placeholder="Type to search">
      </div>
    </form>
    <div class="js-search-results hide"></div>
    <p class="m-not-found align-center hide js-no-results">
      No results for your search, please try with something else.
    </p>
  </div>
</div>

    
<footer class="m-footer">
  <div class="m-footer__content">
    <nav class="m-footer-social">
        <a href="https://www.facebook.com/abarajithan11" target="_blank" rel="noopener" aria-label="Facebook">
          <span class="icon-facebook" aria-hidden="true"></span>
        </a>
      <a href="https://www.linkedin.com/in/abarajithan11" target="_blank" rel="noopener" aria-label="LinkedIn">
        <span class="icon-linkedin" aria-hidden="true"></span>
      </a>
      <a href="https://github.com/abarajithan11" target="_blank" rel="noopener" aria-label="Github">
        <span class="icon-github" aria-hidden="true"></span>
      </a>
      <a href="https://aba-blog.xyz/rss" aria-label="RSS">
        <span class="icon-rss" aria-hidden="true"></span>
      </a>
    </nav>
    <p class="m-footer-copyright">
      <span>Aba&#x27;s Blog &copy; 2022</span>
      <span>&nbsp; &bull; &nbsp;</span>
      <span>Published with <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a></span>
    </p>
    <p class="m-footer-copyright jslicense">
      <a href="../assets/html/javascript.html%3Fv=b8c8d4f5ca.html" rel="jslicense">JavaScript license information</a>
    </p>
  </div>
</footer>

    <script crossorigin="anonymous" src="https://polyfill.io/v3/polyfill.min.js?features=IntersectionObserver%2CPromise%2CArray.prototype.includes%2CString.prototype.endsWith%2CString.prototype.startsWith%2CObject.assign%2CNodeList.prototype.forEach"></script>
    <script defer src="../assets/js/manifest.js%3Fv=b8c8d4f5ca"></script>
    <script defer src="../assets/js/vendor/content-api.min.js%3Fv=b8c8d4f5ca"></script>
    <script defer src="../assets/js/vendor.js%3Fv=b8c8d4f5ca"></script>
    <script defer src="../assets/js/app.js%3Fv=b8c8d4f5ca"></script>

      <script defer src="../assets/js/post.js%3Fv=b8c8d4f5ca"></script>


    <div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v12.0" nonce="C5ma3g6v"></script>

<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        document.querySelectorAll('pre[class*=language-]').forEach(function (node) {
            node.classList.add('line-numbers');
        });
        Prism.highlightAll();
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/plugins/toolbar/prism-toolbar.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-c.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-cpp.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-matlab.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-tcl.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-verilog.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-latex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-verilog.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/components/prism-yaml.min.js"></script>
  </body>
</html>
